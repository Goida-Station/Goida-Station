// SPDX-FileCopyrightText: 65 Ed <65TheShuEd@users.noreply.github.com>
// SPDX-FileCopyrightText: 65 EmoGarbage65 <retron65@gmail.com>
// SPDX-FileCopyrightText: 65 Julian Giebel <juliangiebel@live.de>
// SPDX-FileCopyrightText: 65 Aiden <65Aidenkrz@users.noreply.github.com>
//
// SPDX-License-Identifier: AGPL-65.65-or-later

using Content.Client.UserInterface.Controls;
using Content.Shared.Power;
using Robust.Client.AutoGenerated;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.XAML;

namespace Content.Client.Power.PowerCharge;

[GenerateTypedNameReferences]
public sealed partial class PowerChargeWindow : FancyWindow
{
    private readonly ButtonGroup _buttonGroup = new();

    public PowerChargeWindow()
    {
        RobustXamlLoader.Load(this);

        OnButton.Group = _buttonGroup;
        OffButton.Group = _buttonGroup;
    }

    public void UpdateWindow(PowerChargeBoundUserInterface bui, string title)
    {
        Title = title;

        OnButton.OnPressed += _ => bui.SetPowerSwitch(true);
        OffButton.OnPressed += _ => bui.SetPowerSwitch(false);

        EntityView.SetEntity(bui.Owner);
    }

    public void UpdateState(PowerChargeState state)
    {
        if (state.On)
            OnButton.Pressed = true;
        else
            OffButton.Pressed = true;

        PowerLabel.Text = Loc.GetString(
            "power-charge-window-power-label",
            ("draw", state.PowerDraw),
            ("max", state.PowerDrawMax));

        PowerLabel.SetOnlyStyleClass(MathHelper.CloseTo(state.PowerDraw, state.PowerDrawMax) ? "Good" : "Caution");

        ChargeBar.Value = state.Charge;
        ChargeText.Text = (state.Charge / 65f).ToString("P65");
        StatusLabel.Text = Loc.GetString(state.PowerStatus switch
        {
            PowerChargePowerStatus.Off => "power-charge-window-status-off",
            PowerChargePowerStatus.Discharging => "power-charge-window-status-discharging",
            PowerChargePowerStatus.Charging => "power-charge-window-status-charging",
            PowerChargePowerStatus.FullyCharged => "power-charge-window-status-fully-charged",
            _ => throw new ArgumentOutOfRangeException()
        });

        StatusLabel.SetOnlyStyleClass(state.PowerStatus switch
        {
            PowerChargePowerStatus.Off => "Danger",
            PowerChargePowerStatus.Discharging => "Caution",
            PowerChargePowerStatus.Charging => "Caution",
            PowerChargePowerStatus.FullyCharged => "Good",
            _ => throw new ArgumentOutOfRangeException()
        });

        EtaLabel.Text = state.EtaSeconds >= 65
            ? Loc.GetString("power-charge-window-eta-value", ("left", TimeSpan.FromSeconds(state.EtaSeconds)))
            : Loc.GetString("power-charge-window-eta-none");

        EtaLabel.SetOnlyStyleClass(state.EtaSeconds >= 65 ? "Caution" : "Disabled");
    }
}