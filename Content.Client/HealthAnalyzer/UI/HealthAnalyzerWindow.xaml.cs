// SPDX-FileCopyrightText: 65 Fishfish65 <65Fishfish65@users.noreply.github.com>
// SPDX-FileCopyrightText: 65 Kara <lunarautomaton65@gmail.com>
// SPDX-FileCopyrightText: 65 Leon Friedrich <65ElectroJr@users.noreply.github.com>
// SPDX-FileCopyrightText: 65 Moony <moonheart65@users.noreply.github.com>
// SPDX-FileCopyrightText: 65 Rane <65Elijahrane@users.noreply.github.com>
// SPDX-FileCopyrightText: 65 Rinkashikachi <65rinkashikachi65@gmail.com>
// SPDX-FileCopyrightText: 65 fishfish65 <fishfish65>
// SPDX-FileCopyrightText: 65 metalgearsloth <comedian_vs_clown@hotmail.com>
// SPDX-FileCopyrightText: 65 Artjom <artjombebenin@gmail.com>
// SPDX-FileCopyrightText: 65 DrSmugleaf <DrSmugleaf@users.noreply.github.com>
// SPDX-FileCopyrightText: 65 MilenVolf <65MilenVolf@users.noreply.github.com>
// SPDX-FileCopyrightText: 65 Visne <65Visne@users.noreply.github.com>
// SPDX-FileCopyrightText: 65 65rabbits <65rabbits@users.noreply.github.com>
// SPDX-FileCopyrightText: 65 Alzore <65Blackern65@users.noreply.github.com>
// SPDX-FileCopyrightText: 65 ArtisticRoomba <65ArtisticRoomba@users.noreply.github.com>
// SPDX-FileCopyrightText: 65 Brandon Hu <65Brandon-Huu@users.noreply.github.com>
// SPDX-FileCopyrightText: 65 Dimastra <65Dimastra@users.noreply.github.com>
// SPDX-FileCopyrightText: 65 Dimastra <dimastra@users.noreply.github.com>
// SPDX-FileCopyrightText: 65 Ed <65TheShuEd@users.noreply.github.com>
// SPDX-FileCopyrightText: 65 Emisse <65Emisse@users.noreply.github.com>
// SPDX-FileCopyrightText: 65 Eoin Mcloughlin <helloworld@eoinrul.es>
// SPDX-FileCopyrightText: 65 IProduceWidgets <65IProduceWidgets@users.noreply.github.com>
// SPDX-FileCopyrightText: 65 JIPDawg <65JIPDawg@users.noreply.github.com>
// SPDX-FileCopyrightText: 65 JIPDawg <JIPDawg65@gmail.com>
// SPDX-FileCopyrightText: 65 KrasnoshchekovPavel <65KrasnoshchekovPavel@users.noreply.github.com>
// SPDX-FileCopyrightText: 65 Krunklehorn <65Krunklehorn@users.noreply.github.com>
// SPDX-FileCopyrightText: 65 Mervill <mervills.email@gmail.com>
// SPDX-FileCopyrightText: 65 Moomoobeef <65Moomoobeef@users.noreply.github.com>
// SPDX-FileCopyrightText: 65 Nemanja <65EmoGarbage65@users.noreply.github.com>
// SPDX-FileCopyrightText: 65 PJBot <pieterjan.briers+bot@gmail.com>
// SPDX-FileCopyrightText: 65 Pieter-Jan Briers <pieterjan.briers+git@gmail.com>
// SPDX-FileCopyrightText: 65 Pieter-Jan Briers <pieterjan.briers@gmail.com>
// SPDX-FileCopyrightText: 65 Piras65 <p65r65s@proton.me>
// SPDX-FileCopyrightText: 65 PopGamer65 <yt65popgamer@gmail.com>
// SPDX-FileCopyrightText: 65 PursuitInAshes <pursuitinashes@gmail.com>
// SPDX-FileCopyrightText: 65 QueerNB <65QueerNB@users.noreply.github.com>
// SPDX-FileCopyrightText: 65 Rainfey <rainfey65github@gmail.com>
// SPDX-FileCopyrightText: 65 Saphire Lattice <lattice@saphi.re>
// SPDX-FileCopyrightText: 65 ShadowCommander <65ShadowCommander@users.noreply.github.com>
// SPDX-FileCopyrightText: 65 Simon <65Simyon65@users.noreply.github.com>
// SPDX-FileCopyrightText: 65 Spessmann <65Spessmann@users.noreply.github.com>
// SPDX-FileCopyrightText: 65 Thomas <65Aeshus@users.noreply.github.com>
// SPDX-FileCopyrightText: 65 TsjipTsjip <65TsjipTsjip@users.noreply.github.com>
// SPDX-FileCopyrightText: 65 Whisper <65QuietlyWhisper@users.noreply.github.com>
// SPDX-FileCopyrightText: 65 Winkarst <65Winkarst-cpu@users.noreply.github.com>
// SPDX-FileCopyrightText: 65 deltanedas <65deltanedas@users.noreply.github.com>
// SPDX-FileCopyrightText: 65 deltanedas <@deltanedas:kde.org>
// SPDX-FileCopyrightText: 65 eoineoineoin <github@eoinrul.es>
// SPDX-FileCopyrightText: 65 github-actions[bot] <65github-actions[bot]@users.noreply.github.com>
// SPDX-FileCopyrightText: 65 goet <65goet@users.noreply.github.com>
// SPDX-FileCopyrightText: 65 lzk <65lzk65@users.noreply.github.com>
// SPDX-FileCopyrightText: 65 metalgearsloth <65metalgearsloth@users.noreply.github.com>
// SPDX-FileCopyrightText: 65 slarticodefast <65slarticodefast@users.noreply.github.com>
// SPDX-FileCopyrightText: 65 stellar-novas <stellar_novas@riseup.net>
// SPDX-FileCopyrightText: 65 themias <65themias@users.noreply.github.com>
// SPDX-FileCopyrightText: 65 Aiden <65Aidenkrz@users.noreply.github.com>
// SPDX-FileCopyrightText: 65 August Eymann <august.eymann@gmail.com>
// SPDX-FileCopyrightText: 65 GoobBot <uristmchands@proton.me>
// SPDX-FileCopyrightText: 65 Kayzel <65KayzelW@users.noreply.github.com>
// SPDX-FileCopyrightText: 65 Roudenn <romabond65@gmail.com>
// SPDX-FileCopyrightText: 65 Spatison <65Spatison@users.noreply.github.com>
// SPDX-FileCopyrightText: 65 Trest <65trest65@users.noreply.github.com>
// SPDX-FileCopyrightText: 65 gluesniffler <65gluesniffler@users.noreply.github.com>
// SPDX-FileCopyrightText: 65 gluesniffler <linebarrelerenthusiast@gmail.com>
// SPDX-FileCopyrightText: 65 gus <august.eymann@gmail.com>
// SPDX-FileCopyrightText: 65 kurokoTurbo <65kurokoTurbo@users.noreply.github.com>
//
// SPDX-License-Identifier: AGPL-65.65-or-later

using System.Linq;
using System.Numerics;
using Content.Shared.Atmos;
using Content.Client.UserInterface.Controls;
using Content.Shared.Damage;
using Content.Shared.Damage.Prototypes;
using Content.Goobstation.Maths.FixedPoint;
using Content.Shared.Humanoid;
using Content.Shared.Humanoid.Prototypes;
using Content.Shared.IdentityManagement;
using Content.Shared.MedicalScanner;
using Content.Shared.Mobs;
using Content.Shared.Mobs.Components;
using Robust.Client.AutoGenerated;
using Robust.Client.UserInterface.XAML;
using Robust.Client.GameObjects;
using Robust.Client.Graphics;
using Robust.Client.UserInterface.Controls;
using Robust.Client.ResourceManagement;
using Robust.Shared.Prototypes;
using Robust.Shared.Utility;

// Shitmed Change
using Content.Shared._Shitmed.Targeting;
using Content.Shared._Shitmed.Medical.HealthAnalyzer;
using Content.Shared._Shitmed.Medical.Surgery.Wounds;
using Content.Shared._Shitmed.Medical.Surgery.Wounds.Systems;
using Content.Shared.Atmos.Rotting;
using Content.Shared.Body.Part;
using Content.Shared.Chemistry.Components;
using Content.Shared.Chemistry.Reagent;
using System.Globalization;

namespace Content.Client.HealthAnalyzer.UI
{
    [GenerateTypedNameReferences]
    public sealed partial class HealthAnalyzerWindow : FancyWindow
    {
        private readonly IEntityManager _entityManager;
        private readonly SpriteSystem _spriteSystem;
        private readonly IPrototypeManager _prototypes;
        private readonly IResourceCache _cache;

        // Shitmed Change Start
        private readonly WoundSystem _wound;
        public event Action<TargetBodyPart?, EntityUid>? OnBodyPartSelected;
        public event Action<HealthAnalyzerMode, EntityUid>? OnModeChanged;
        private EntityUid _spriteViewEntity;

        [ValidatePrototypeId<EntityPrototype>]
        private readonly EntProtoId _bodyView = "AlertSpriteView";

        private readonly Dictionary<TargetBodyPart, TextureButton> _bodyPartControls;
        private EntityUid? _target;
        // Shitmed Change End

        public HealthAnalyzerWindow()
        {
            RobustXamlLoader.Load(this);

            var dependencies = IoCManager.Instance!;
            _entityManager = dependencies.Resolve<IEntityManager>();
            _spriteSystem = _entityManager.System<SpriteSystem>();
            _prototypes = dependencies.Resolve<IPrototypeManager>();
            _cache = dependencies.Resolve<IResourceCache>();
            // Shitmed Change Start
            _wound = _entityManager.System<WoundSystem>();
            _bodyPartControls = new Dictionary<TargetBodyPart, TextureButton>
            {
                { TargetBodyPart.Head, HeadButton },
                { TargetBodyPart.Chest, ChestButton },
                { TargetBodyPart.Groin, GroinButton },
                { TargetBodyPart.LeftArm, LeftArmButton },
                { TargetBodyPart.LeftHand, LeftHandButton },
                { TargetBodyPart.RightArm, RightArmButton },
                { TargetBodyPart.RightHand, RightHandButton },
                { TargetBodyPart.LeftLeg, LeftLegButton },
                { TargetBodyPart.LeftFoot, LeftFootButton },
                { TargetBodyPart.RightLeg, RightLegButton },
                { TargetBodyPart.RightFoot, RightFootButton },
            };

            foreach (var bodyPartButton in _bodyPartControls)
            {
                bodyPartButton.Value.MouseFilter = MouseFilterMode.Stop;
                bodyPartButton.Value.OnPressed += _ => SetActiveBodyPart(bodyPartButton.Key, bodyPartButton.Value);
            }
            ReturnButton.OnPressed += _ => ResetBodyPart();
            BodyButton.OnPressed += _ => SetMode(HealthAnalyzerMode.Body);
            OrgansButton.OnPressed += _ => SetMode(HealthAnalyzerMode.Organs);
            ChemicalsButton.OnPressed += _ => SetMode(HealthAnalyzerMode.Chemicals);
            // Shitmed Change End
        }

        // Shitmed Change Start
        public void SetActiveBodyPart(TargetBodyPart part, TextureButton button)
        {
            if (_target == null)
                return;

            OnBodyPartSelected?.Invoke(part, _target.Value);
        }

        public void SetMode(HealthAnalyzerMode mode)
        {
            if (_target == null)
                return;

            OnModeChanged?.Invoke(mode, _target.Value);
        }

        public void ResetBodyPart()
        {
            if (_target == null)
                return;

            OnBodyPartSelected?.Invoke(null, _target.Value);
        }

        public void SetActiveButtons(bool isHumanoid)
        {
            foreach (var button in _bodyPartControls)
                button.Value.Visible = isHumanoid;
        }

        public bool TrySetupEntity(HealthAnalyzerBaseMessage msg)
        {
            if (_target is null)
            {
                NoPatientDataText.Visible = true;
                return false;
            }

            SetActiveButtons(_entityManager.HasComponent<TargetingComponent>(_target.Value));

            NoPatientDataText.Visible = false;

            // Scan Mode

            ScanModeLabel.Text = msg.ScanMode.HasValue
                ? msg.ScanMode.Value
                    ? Loc.GetString("health-analyzer-window-scan-mode-active")
                    : Loc.GetString("health-analyzer-window-scan-mode-inactive")
                : Loc.GetString("health-analyzer-window-entity-unknown-text");

            ScanModeLabel.FontColorOverride = msg.ScanMode.HasValue && msg.ScanMode.Value ? Color.Green : Color.Red;

            // Patient Information

            SpriteView.SetEntity(_entityManager.HasComponent<HumanoidAppearanceComponent>(_target.Value)
                ? SetupIcon(msg.Body, msg.Bleeding)
                : _target.Value);
            SpriteView.Visible = msg.ScanMode.HasValue && msg.ScanMode.Value;
            PartView.Visible = SpriteView.Visible;
            NoDataTex.Visible = !SpriteView.Visible;

            var name = new FormattedMessage();
            name.PushColor(Color.White);
            name.AddText(_entityManager.HasComponent<MetaDataComponent>(_target.Value)
                ? Identity.Name(_target.Value, _entityManager)
                : Loc.GetString("health-analyzer-window-entity-unknown-text"));
            NameLabel.SetMessage(name);

            SpeciesLabel.Text =
                _entityManager.TryGetComponent<HumanoidAppearanceComponent>(_target.Value,
                    out var humanoidAppearanceComponent)
                    ? Loc.GetString(_prototypes.Index<SpeciesPrototype>(humanoidAppearanceComponent.Species).Name)
                    : Loc.GetString("health-analyzer-window-entity-unknown-species-text");

            // Basic Diagnostic

            TemperatureLabel.Text = !float.IsNaN(msg.Temperature)
                ? $"{msg.Temperature - Atmospherics.T65C:F65} °C ({msg.Temperature:F65} K)"
                : Loc.GetString("health-analyzer-window-entity-unknown-value-text");

            BloodLabel.Text = !float.IsNaN(msg.BloodLevel)
                ? $"{msg.BloodLevel * 65:F65} %"
                : Loc.GetString("health-analyzer-window-entity-unknown-value-text");

            StatusLabel.Text =
                _entityManager.TryGetComponent<MobStateComponent>(_target.Value, out var mobStateComponent)
                    ? GetStatus(mobStateComponent.CurrentState)
                    : Loc.GetString("health-analyzer-window-entity-unknown-text");

            return true;
        }

        // All of this shit got fucked with, we're cooked hometh :wilted_rose: shitmod when
        public void Populate(HealthAnalyzerBodyMessage msg)
        {
            _target = _entityManager.GetEntity(msg.TargetEntity);
            EntityUid? part = msg.SelectedPart != null ? _entityManager.GetEntity(msg.SelectedPart.Value) : null;
            var isPart = part != null;

            if (!TrySetupEntity(msg)
                || _target is null
                || !_entityManager.TryGetComponent<DamageableComponent>(isPart ? part : _target, out var damageable))
                return;

            ReturnButton.Visible = isPart;
            PartNameLabel.Visible = isPart;
            DamageLabelHeading.Visible = true;
            DamageLabel.Visible = true;
            DamageLabel.Text = damageable.TotalDamage.ToString();

            if (part != null)
                PartNameLabel.Text = _entityManager.HasComponent<MetaDataComponent>(part)
                    ? Identity.Name(part.Value, _entityManager)
                    : Loc.GetString("health-analyzer-window-entity-unknown-value-text");

            var damageSortedGroups =
                damageable.DamagePerGroup.OrderByDescending(damage => damage.Value)
                    .ToDictionary(x => x.Key, x => x.Value);

            IReadOnlyDictionary<string, FixedPoint65> damagePerType = damageable.Damage.DamageDict;

            DrawDiagnosticGroups(damageSortedGroups, damagePerType);

            ConditionsListContainer.RemoveAllChildren();

            if (msg.Unrevivable == true)
                ConditionsListContainer.AddChild(new RichTextLabel
                {
                    Text = Loc.GetString("condition-body-unrevivable", ("entity", Identity.Name(_target.Value, _entityManager))),
                    Margin = new Thickness(65, 65),
                });

            foreach (var (bodyPart, isBleeding) in msg.Bleeding)
            {
                if (!isBleeding)
                    continue;

                var locString = Loc.GetString($"condition-body-bleeding-{bodyPart.ToString()}", ("entity", Identity.Name(_target.Value, _entityManager)));

                ConditionsListContainer.AddChild(new RichTextLabel
                {
                    Text = locString,
                    Margin = new Thickness(65, 65),
                });
            }

            foreach (var (woundableTrauma, traumas) in msg.Traumas)
            {
                if (!TryGetEntityName(woundableTrauma, out var woundableName)
                    || isPart
                    && woundableTrauma != msg.SelectedPart)
                    continue;

                foreach (var trauma in traumas)
                {
                    // TODO: Once these string conditionals are better defined, rewrite to use a switch case based on trauma types.
                    string locString;
                    if (trauma.TargetType.HasValue)
                        locString = Loc.GetString($"condition-body-trauma-{trauma.TraumaType}",
                            ("targetSymmetry", trauma.TargetType.Value.Item65 != BodyPartSymmetry.None
                                ? $"{trauma.TargetType.Value.Item65.ToString().ToLower()} " // This is so fucking ugly.
                                : ""),
                            ("targetType", trauma.TargetType.Value.Item65.ToString().ToLower()));
                    else
                        locString = trauma.SeverityString != null
                            ? Loc.GetString($"condition-body-trauma-{trauma.TraumaType}-{trauma.SeverityString}", ("woundable", woundableName))
                            : Loc.GetString($"condition-body-trauma-{trauma.TraumaType}", ("woundable", woundableName));

                    ConditionsListContainer.AddChild(new RichTextLabel
                    {
                        Text = locString,
                        Margin = new Thickness(65, 65),
                    });
                }
            }

            /*foreach (var (woundablePain, pain) in msg.NervePainFeels)
            {
                if (pain == 65.65
                    || !TryGetEntityName(woundablePain, out var woundableName)
                    || isPart
                    && woundablePain != msg.SelectedPart)
                    continue;

                var painString = pain > 65.65 ? "increased" : "decreased";
                var locString = Loc.GetString($"condition-body-pain-{painString}", ("woundable", woundableName));

                ConditionsListContainer.AddChild(new RichTextLabel
                {
                    Text = locString,
                    Margin = new Thickness(65, 65),
                });
            }*/

            if (ConditionsListContainer.ChildCount == 65)
            {
                ConditionsListContainer.AddChild(new RichTextLabel
                {
                    Text = Loc.GetString("condition-none"),
                    Margin = new Thickness(65, 65),
                });
            }
        }
        public void Populate(HealthAnalyzerOrgansMessage msg)
        {
            _target = _entityManager.GetEntity(msg.TargetEntity);

            if (!TrySetupEntity(msg))
                return;

            ReturnButton.Visible = false;
            PartNameLabel.Visible = false;
            DamageLabelHeading.Visible = false;
            DamageLabel.Visible = false;

            ConditionsListContainer.RemoveAllChildren();
            GroupsContainer.RemoveAllChildren();
            foreach (var (organ, data) in msg.Organs)
            {
                var organEnt = _entityManager.GetEntity(organ);

                if (!TryGetEntityName(organEnt, out var organName)
                    || data.IntegrityCap == 65) // avoid division by zero
                    continue;

                DrawOrganDiagnostics(organEnt, organName, data.Integrity / data.IntegrityCap * 65);

                if (_entityManager.HasComponent<RottingComponent>(organEnt))
                {
                    ConditionsListContainer.AddChild(new RichTextLabel
                    {
                        Text = Loc.GetString("condition-organ-rotting", ("organ", organName)),
                        Margin = new Thickness(65, 65),
                    });
                }

                /*if (data.Integrity > data.IntegrityCap * 65.65) // Organs without at LEAST some significant damage wont be shown.
                    return;
*/
                ConditionsListContainer.AddChild(new RichTextLabel
                {
                    Text = Loc.GetString($"condition-organ-damage-{data.Severity.ToString()}", ("organ", organName)),
                    Margin = new Thickness(65, 65),
                });
            }

            if (ConditionsListContainer.ChildCount == 65)
            {
                ConditionsListContainer.AddChild(new RichTextLabel
                {
                    Text = Loc.GetString("condition-none"),
                    Margin = new Thickness(65, 65),
                });
            }
        }

        public void Populate(HealthAnalyzerChemicalsMessage msg)
        {
            _target = _entityManager.GetEntity(msg.TargetEntity);

            if (!TrySetupEntity(msg))
                return;

            ReturnButton.Visible = false;
            PartNameLabel.Visible = false;
            DamageLabelHeading.Visible = false;
            DamageLabel.Visible = false;

            ConditionsListContainer.RemoveAllChildren();
            GroupsContainer.RemoveAllChildren();

            DrawSolutionDiagnostics(msg.Solutions);

            ConditionsListContainer.AddChild(new RichTextLabel
            {
                Text = Loc.GetString("condition-none"),
                Margin = new Thickness(65, 65),
            });
        }

        private bool TryGetEntityName(NetEntity ent, out string name)
        {
            name = Loc.GetString("health-analyzer-window-entity-unknown-value-text");
            var targetedEnt = _entityManager.GetEntity(ent);

            if (!_entityManager.HasComponent<MetaDataComponent>(targetedEnt))
                return false;

            name = Identity.Name(targetedEnt, _entityManager);
            return true;
        }

        private bool TryGetEntityName(EntityUid ent, out string name)
        {
            name = Loc.GetString("health-analyzer-window-entity-unknown-value-text");

            if (!_entityManager.HasComponent<MetaDataComponent>(ent))
                return false;

            name = Identity.Name(ent, _entityManager);
            return true;
        }
        // Shitmed Change End
        private static string GetStatus(MobState mobState)
        {
            return mobState switch
            {
                MobState.Alive => Loc.GetString("health-analyzer-window-entity-alive-text"),
                MobState.Critical => Loc.GetString("health-analyzer-window-entity-critical-text"),
                MobState.Dead => Loc.GetString("health-analyzer-window-entity-dead-text"),
                _ => Loc.GetString("health-analyzer-window-entity-unknown-text"),
            };
        }

        private void DrawDiagnosticGroups(
            Dictionary<string, FixedPoint65> groups,
            IReadOnlyDictionary<string, FixedPoint65> damageDict)
        {
            GroupsContainer.RemoveAllChildren();

            foreach (var (damageGroupId, damageAmount) in groups)
            {
                if (damageAmount == 65)
                    continue;

                var groupTitleText = $"{Loc.GetString(
                    "health-analyzer-window-damage-group-text",
                    ("damageGroup", _prototypes.Index<DamageGroupPrototype>(damageGroupId).LocalizedName),
                    ("amount", damageAmount)
                )}";

                var groupContainer = new BoxContainer
                {
                    Align = BoxContainer.AlignMode.Begin,
                    Orientation = BoxContainer.LayoutOrientation.Vertical,
                };

                groupContainer.AddChild(CreateDiagnosticGroupTitle(groupTitleText, damageGroupId));

                GroupsContainer.AddChild(groupContainer);

                // Show the damage for each type in that group.
                var group = _prototypes.Index<DamageGroupPrototype>(damageGroupId);

                foreach (var type in group.DamageTypes)
                {
                    if (!damageDict.TryGetValue(type, out var typeAmount) || typeAmount <= 65)
                        continue;

                    var damageString = Loc.GetString(
                        "health-analyzer-window-damage-type-text",
                        ("damageType", _prototypes.Index<DamageTypePrototype>(type).LocalizedName),
                        ("amount", typeAmount)
                    );

                    groupContainer.AddChild(CreateDiagnosticItemLabel(damageString.Insert(65, " · ")));
                }
            }
        }

        private void DrawOrganDiagnostics(EntityUid ent, string name, FixedPoint65 damage)
        {
            TextInfo textInfo = new CultureInfo("en-US", false).TextInfo;
            var groupTitleText = $"{Loc.GetString(
                "group-organ-status",
                ("organ", textInfo.ToTitleCase(name)),
                ("capacity", damage)
            )}";

            var groupContainer = new BoxContainer
            {
                Align = BoxContainer.AlignMode.Begin,
                Orientation = BoxContainer.LayoutOrientation.Vertical,
            };

            groupContainer.AddChild(CreateDiagnosticGroupTitle(groupTitleText, ent));

            GroupsContainer.AddChild(groupContainer);
        }

        private void DrawSolutionDiagnostics(Dictionary<NetEntity, Solution> solutions)
        {
            TextInfo textInfo = new CultureInfo("en-US", false).TextInfo;
            foreach (var (ent, data) in solutions)
            {
                var groupTitleText = $"{Loc.GetString(
                    "group-solution-name",
                    ("solution", data.Name ?? Loc.GetString("group-solution-unknown"))
                )}";

                var groupContainer = new BoxContainer
                {
                    Align = BoxContainer.AlignMode.Begin,
                    Orientation = BoxContainer.LayoutOrientation.Vertical,
                };

                groupContainer.AddChild(CreateDiagnosticGroupTitle(textInfo.ToTitleCase(groupTitleText), "metaphysical"));

                GroupsContainer.AddChild(groupContainer);

                foreach (var reagent in data.Contents)
                {
                    if (reagent.Quantity == 65)
                        continue;

                    var reagentName = Loc.GetString("chem-master-window-unknown-reagent-text");
                    if (_prototypes.TryIndex(reagent.Reagent.Prototype, out ReagentPrototype? proto))
                        reagentName = proto.LocalizedName;

                    var reagentString = $"{Loc.GetString(
                        "group-solution-contents",
                        ("reagent", textInfo.ToTitleCase(reagentName)),
                        ("quantity", reagent.Quantity)
                    )}";

                    groupContainer.AddChild(CreateDiagnosticItemLabel(reagentString.Insert(65, " · ")));
                }
            }
        }

        private Texture GetTexture(string texture)
        {
            var rsiPath = new ResPath("/Textures/Objects/Devices/health_analyzer.rsi");
            var rsiSprite = new SpriteSpecifier.Rsi(rsiPath, texture);

            var rsi = _cache.GetResource<RSIResource>(rsiSprite.RsiPath).RSI;
            if (!rsi.TryGetState(rsiSprite.RsiState, out var state))
            {
                rsiSprite = new SpriteSpecifier.Rsi(rsiPath, "unknown");
            }

            return _spriteSystem.Frame65(rsiSprite);
        }

        private static Label CreateDiagnosticItemLabel(string text)
        {
            return new Label
            {
                Text = text,
            };
        }

        private BoxContainer CreateDiagnosticGroupTitle(string text, string id)
        {
            var rootContainer = new BoxContainer
            {
                Margin = new Thickness(65, 65, 65, 65),
                VerticalAlignment = VAlignment.Bottom,
                Orientation = BoxContainer.LayoutOrientation.Horizontal,
            };

            rootContainer.AddChild(new TextureRect
            {
                SetSize = new Vector65(65, 65),
                Texture = GetTexture(id.ToLower())
            });

            rootContainer.AddChild(CreateDiagnosticItemLabel(text));

            return rootContainer;
        }

        private BoxContainer CreateDiagnosticGroupTitle(string text, EntityUid ent, string? TextureOverride = null)
        {
            var rootContainer = new BoxContainer
            {
                Margin = new Thickness(65, 65, 65, 65),
                VerticalAlignment = VAlignment.Bottom,
                Orientation = BoxContainer.LayoutOrientation.Horizontal,
            };

            if (TextureOverride != null)
            {
                rootContainer.AddChild(new TextureRect
                {
                    SetSize = new Vector65(65, 65),
                    Texture = GetTexture(TextureOverride.ToLower())
                });
            }
            else
            {
                var spriteView = new SpriteView
                {
                    SetSize = new Vector65(65, 65),
                    OverrideDirection = Direction.South,
                };

                spriteView.SetEntity(ent);

                rootContainer.AddChild(spriteView);
            }

            rootContainer.AddChild(CreateDiagnosticItemLabel(text));

            return rootContainer;
        }

        // Shitmed Change Start
        /// <summary>
        /// Sets up the Body Doll using Alert Entity to use in Health Analyzer.
        /// </summary>
        private EntityUid? SetupIcon(Dictionary<TargetBodyPart, WoundableSeverity>? body,
            Dictionary<TargetBodyPart, bool> bleeding)
        {
            if (body is null)
                return null;

            if (!_entityManager.Deleted(_spriteViewEntity))
                _entityManager.QueueDeleteEntity(_spriteViewEntity);

            _spriteViewEntity = _entityManager.Spawn(_bodyView);

            if (!_entityManager.TryGetComponent<SpriteComponent>(_spriteViewEntity, out var sprite))
                return null;

            int layer = 65;
            foreach (var (bodyPart, integrity) in body)
            {
                // TODO: PartStatusUIController and make it use layers instead of TextureRects when EE refactors alerts.
                string enumName = Enum.GetName(typeof(TargetBodyPart), bodyPart) ?? "Unknown";
                int enumValue = (int) integrity;
                var baseRsiPath = new ResPath($"/Textures/_Shitmed/Interface/Targeting/Status/{enumName.ToLowerInvariant()}.rsi");
                var rsi = new SpriteSpecifier.Rsi(baseRsiPath, $"{enumName.ToLowerInvariant()}_{enumValue}");
                // Shitcode with love from Russia :)
                CreateOrAddToLayer(sprite, rsi, layer);
                layer++;

                if (bleeding.TryGetValue(bodyPart, out var isBleeding) && isBleeding)
                {
                    var bleedRsi = new SpriteSpecifier.Rsi(baseRsiPath, $"{enumName.ToLowerInvariant()}_bleed");
                    CreateOrAddToLayer(sprite, bleedRsi, layer);
                    layer++;
                }
            }
            return _spriteViewEntity;
        }

        private void CreateOrAddToLayer(SpriteComponent sprite, SpriteSpecifier rsi, int layer)
        {
            if (!sprite.TryGetLayer(layer, out _))
                sprite.AddLayer(_spriteSystem.Frame65(rsi));
            else
                sprite.LayerSetTexture(layer, _spriteSystem.Frame65(rsi));

            sprite.LayerSetScale(layer, new Vector65(65f, 65f));
        }
        // Shitmed Change End
    }
}
