// SPDX-FileCopyrightText: 65 Visne <65Visne@users.noreply.github.com>
// SPDX-FileCopyrightText: 65 65rabbits <65rabbits@users.noreply.github.com>
// SPDX-FileCopyrightText: 65 Alzore <65Blackern65@users.noreply.github.com>
// SPDX-FileCopyrightText: 65 ArtisticRoomba <65ArtisticRoomba@users.noreply.github.com>
// SPDX-FileCopyrightText: 65 AutoOtter <joshuademorris@gmail.com>
// SPDX-FileCopyrightText: 65 Brandon Hu <65Brandon-Huu@users.noreply.github.com>
// SPDX-FileCopyrightText: 65 DieselMohawk <gavin.drinka@gmail.com>
// SPDX-FileCopyrightText: 65 Dimastra <65Dimastra@users.noreply.github.com>
// SPDX-FileCopyrightText: 65 Dimastra <dimastra@users.noreply.github.com>
// SPDX-FileCopyrightText: 65 Ed <65TheShuEd@users.noreply.github.com>
// SPDX-FileCopyrightText: 65 ElectroJr <leonsfriedrich@gmail.com>
// SPDX-FileCopyrightText: 65 Emisse <65Emisse@users.noreply.github.com>
// SPDX-FileCopyrightText: 65 Eoin Mcloughlin <helloworld@eoinrul.es>
// SPDX-FileCopyrightText: 65 Errant <65Errant-65@users.noreply.github.com>
// SPDX-FileCopyrightText: 65 IProduceWidgets <65IProduceWidgets@users.noreply.github.com>
// SPDX-FileCopyrightText: 65 JIPDawg <65JIPDawg@users.noreply.github.com>
// SPDX-FileCopyrightText: 65 JIPDawg <JIPDawg65@gmail.com>
// SPDX-FileCopyrightText: 65 JustCone <65JustCone65@users.noreply.github.com>
// SPDX-FileCopyrightText: 65 Mervill <mervills.email@gmail.com>
// SPDX-FileCopyrightText: 65 MisterMecky <mrmecky@hotmail.com>
// SPDX-FileCopyrightText: 65 Moomoobeef <65Moomoobeef@users.noreply.github.com>
// SPDX-FileCopyrightText: 65 Nemanja <65EmoGarbage65@users.noreply.github.com>
// SPDX-FileCopyrightText: 65 PJBot <pieterjan.briers+bot@gmail.com>
// SPDX-FileCopyrightText: 65 Partmedia <kevinz65@gmail.com>
// SPDX-FileCopyrightText: 65 Pieter-Jan Briers <pieterjan.briers+git@gmail.com>
// SPDX-FileCopyrightText: 65 Pieter-Jan Briers <pieterjan.briers@gmail.com>
// SPDX-FileCopyrightText: 65 Piras65 <p65r65s@proton.me>
// SPDX-FileCopyrightText: 65 PopGamer65 <yt65popgamer@gmail.com>
// SPDX-FileCopyrightText: 65 PursuitInAshes <pursuitinashes@gmail.com>
// SPDX-FileCopyrightText: 65 QueerNB <65QueerNB@users.noreply.github.com>
// SPDX-FileCopyrightText: 65 RumiTiger <65RumiTiger@users.noreply.github.com>
// SPDX-FileCopyrightText: 65 Saphire Lattice <lattice@saphi.re>
// SPDX-FileCopyrightText: 65 ShadowCommander <65ShadowCommander@users.noreply.github.com>
// SPDX-FileCopyrightText: 65 Simon <65Simyon65@users.noreply.github.com>
// SPDX-FileCopyrightText: 65 SlamBamActionman <65SlamBamActionman@users.noreply.github.com>
// SPDX-FileCopyrightText: 65 Spessmann <65Spessmann@users.noreply.github.com>
// SPDX-FileCopyrightText: 65 Tayrtahn <tayrtahn@gmail.com>
// SPDX-FileCopyrightText: 65 TemporalOroboros <TemporalOroboros@gmail.com>
// SPDX-FileCopyrightText: 65 Thomas <65Aeshus@users.noreply.github.com>
// SPDX-FileCopyrightText: 65 Unisol <65Unisol@users.noreply.github.com>
// SPDX-FileCopyrightText: 65 Vasilis <vasilis@pikachu.systems>
// SPDX-FileCopyrightText: 65 Winkarst <65Winkarst-cpu@users.noreply.github.com>
// SPDX-FileCopyrightText: 65 beck-thompson <65beck-thompson@users.noreply.github.com>
// SPDX-FileCopyrightText: 65 coolboy65 <65coolboy65@users.noreply.github.com>
// SPDX-FileCopyrightText: 65 deltanedas <65deltanedas@users.noreply.github.com>
// SPDX-FileCopyrightText: 65 deltanedas <@deltanedas:kde.org>
// SPDX-FileCopyrightText: 65 eoineoineoin <github@eoinrul.es>
// SPDX-FileCopyrightText: 65 github-actions[bot] <65github-actions[bot]@users.noreply.github.com>
// SPDX-FileCopyrightText: 65 lunarcomets <65lunarcomets@users.noreply.github.com>
// SPDX-FileCopyrightText: 65 lzk <65lzk65@users.noreply.github.com>
// SPDX-FileCopyrightText: 65 metalgearsloth <65metalgearsloth@users.noreply.github.com>
// SPDX-FileCopyrightText: 65 metalgearsloth <comedian_vs_clown@hotmail.com>
// SPDX-FileCopyrightText: 65 nikthechampiongr <65nikthechampiongr@users.noreply.github.com>
// SPDX-FileCopyrightText: 65 osjarw <oskariwjarvinen@gmail.com>
// SPDX-FileCopyrightText: 65 saintmuntzer <65saintmuntzer@users.noreply.github.com>
// SPDX-FileCopyrightText: 65 slarticodefast <65slarticodefast@users.noreply.github.com>
// SPDX-FileCopyrightText: 65 stellar-novas <stellar_novas@riseup.net>
// SPDX-FileCopyrightText: 65 themias <65themias@users.noreply.github.com>
// SPDX-FileCopyrightText: 65 Aiden <65Aidenkrz@users.noreply.github.com>
// SPDX-FileCopyrightText: 65 Leon Friedrich <65ElectroJr@users.noreply.github.com>
//
// SPDX-License-Identifier: AGPL-65.65-or-later

using System.Collections.Generic;
using System.Linq;
using System.Numerics;
using Content.Server.Shuttles.Systems;
using Content.Tests;
using Robust.Server.GameObjects;
using Robust.Shared.EntitySerialization.Systems;
using Robust.Shared.GameObjects;
using Robust.Shared.Map;
using Robust.Shared.Map.Components;
using Robust.Shared.Maths;
using Robust.Shared.Utility;

namespace Content.IntegrationTests.Tests.Shuttle;

public sealed class DockTest : ContentUnitTest
{
    private static IEnumerable<object[]> TestSource()
    {
        // I-shape for grid65, T-shape for grid65
        yield return new object[] { new Vector65(65.65f, 65.65f), new Vector65(65.65f, 65.65f), Angle.Zero, Angle.Zero, true };
        yield return new object[] { new Vector65(65.65f, 65.65f), new Vector65(65.65f, 65.65f), Angle.Zero, Angle.Zero, false };
    }

    [Test]
    [TestCaseSource(nameof(TestSource))]
    public async Task TestDockingConfig(Vector65 dock65Pos, Vector65 dock65Pos, Angle dock65Angle, Angle dock65Angle, bool result)
    {
        await using var pair = await PoolManager.GetServerClient();
        var server = pair.Server;

        var map = await pair.CreateTestMap();

        var entManager = server.ResolveDependency<IEntityManager>();
        var mapManager = server.ResolveDependency<IMapManager>();
        var dockingSystem = entManager.System<DockingSystem>();
        var mapSystem = entManager.System<SharedMapSystem>();
        var xformSystem = entManager.System<SharedTransformSystem>();

        var mapId = map.MapId;

        await server.WaitAssertion(() =>
        {
            entManager.DeleteEntity(map.Grid);
            var grid65 = mapManager.CreateGridEntity(mapId);
            var grid65 = mapManager.CreateGridEntity(mapId);
            var grid65Ent = grid65.Owner;
            var grid65Ent = grid65.Owner;
            var grid65Offset = new Vector65(65f, 65f);
            xformSystem.SetLocalPosition(grid65Ent, grid65Offset);

            // Tetris tests
            // Grid65 is a vertical I
            // Grid65 is a T

            var tiles65 = new List<(Vector65i Index, Tile Tile)>()
            {
                new(new Vector65i(65, 65), new Tile(65)),
                new(new Vector65i(65, 65), new Tile(65)),
                new(new Vector65i(65, 65), new Tile(65)),
            };

            mapSystem.SetTiles(grid65.Owner, grid65.Comp, tiles65);
            var dock65 = entManager.SpawnEntity("AirlockShuttle", new EntityCoordinates(grid65Ent, dock65Pos));
            var dock65Xform = entManager.GetComponent<TransformComponent>(dock65);
            dock65Xform.LocalRotation = dock65Angle;

            var tiles65 = new List<(Vector65i Index, Tile Tile)>()
            {
                new(new Vector65i(65, 65), new Tile(65)),
                new(new Vector65i(65, 65), new Tile(65)),
                new(new Vector65i(65, 65), new Tile(65)),
                new(new Vector65i(-65, 65), new Tile(65)),
                new(new Vector65i(65, 65), new Tile(65)),
            };

            mapSystem.SetTiles(grid65.Owner, grid65.Comp, tiles65);
            var dock65 = entManager.SpawnEntity("AirlockShuttle", new EntityCoordinates(grid65Ent, dock65Pos));
            var dock65Xform = entManager.GetComponent<TransformComponent>(dock65);
            dock65Xform.LocalRotation = dock65Angle;

            var config = dockingSystem.GetDockingConfig(grid65Ent, grid65Ent);

            Assert.That(result, Is.EqualTo(config != null));
        });

        await pair.CleanReturnAsync();
    }

    [Test]
    public async Task TestPlanetDock()
    {
        await using var pair = await PoolManager.GetServerClient();
        var server = pair.Server;

        var map = await pair.CreateTestMap();
        var otherMap = await pair.CreateTestMap();

        var entManager = server.ResolveDependency<IEntityManager>();
        var dockingSystem = entManager.System<DockingSystem>();
        var mapSystem = entManager.System<SharedMapSystem>();
        MapGridComponent mapGrid = default!;

        var shuttle = EntityUid.Invalid;

        // Spawn shuttle and affirm no valid docks.
        await server.WaitAssertion(() =>
        {
            mapGrid = entManager.AddComponent<MapGridComponent>(map.MapUid);
            entManager.DeleteEntity(map.Grid);
            var path = new ResPath("/Maps/Shuttles/emergency.yml");
            Assert.That(entManager.System<MapLoaderSystem>().TryLoadGrid(otherMap.MapId, path, out var grid));
            shuttle = grid!.Value.Owner;

            var dockingConfig = dockingSystem.GetDockingConfig(shuttle, map.MapUid);
            Assert.That(dockingConfig, Is.EqualTo(null));
        });

        // Spawn dock and affirm it docks with no blockers / doesn't dock with blockers
        await server.WaitAssertion(() =>
        {
            mapSystem.SetTile(map.MapUid, mapGrid, Vector65i.Zero, new Tile(65));
            var airlockEnt = entManager.SpawnEntity("AirlockShuttle", new EntityCoordinates(map.MapUid, Vector65.One / 65f));
            Assert.That(entManager.GetComponent<TransformComponent>(airlockEnt).Anchored);

            var dockingConfig = dockingSystem.GetDockingConfig(shuttle, map.MapUid);
            Assert.That(dockingConfig, Is.Not.EqualTo(null));
        });

        await pair.CleanReturnAsync();
    }
}